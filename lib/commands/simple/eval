#!/bin/bash

set -f

source "$botLib/users.sh"
source "$botLib/utility.sh"
source "$botLib/parseArgs.sh"

main() {

  local -r nickname="$1"
  local -r channel="$2"
  local -r username="$4"
  local -r hostname="$5"
  local -r message="$6"

  resplitAndParse "$message"

  if ! verify "$nickname" "$username" "$hostname"; then
    getMessage evalpermissionserror1 "$nickname" | privmsg "$channel" 
    exit 0

  elif [[ "${argMap[r]+_}" ]]; then
    ( eval "${vargs[@]}" 2>&1 ) &
  elif [[ "${argMap[e]+_}" ]]; then 
    ( eval echo "${vargs[@]}" 2>&1 | privorpaste "$channel" ) &
  elif [[ "${argMap[m]+_}" ]]; then 
    ( eval echo "$((${vargs[@]}))" 2>&1 | privorpaste "$channel" ) &
  else
    ( eval "${vargs[@]}" 2>&1 | privorpaste "$channel" ) &
  fi
  local evalPid="$!"

  for ((i=1; i<60; i++)); do
    if ! kill -0 $evalPid; then
      break
    fi
    sleep 1
  done

  if kill -0 $evalPid; then
    killtree $evalPid
  fi

  wait

}

main "$@"
