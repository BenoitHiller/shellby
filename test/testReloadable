
testTrivial() {
  cat >"$tmpDir/1" <<EOF
#!/bin/bash
read line
echo b
sed 'd'
EOF
  chmod +x "$tmpDir/1"
  echo a | reloadable "$tmpDir/1" > "$tmpDir/1.out" &
  local process="$!"
  for ((i=5; i > 0; i--)); do
    if cmp -s <(echo b) "$tmpDir/1.out"; then
      killtree "$process"
      return 0
    else
      sleep 1
    fi
  done
  killtree "$process"
  assertFail
}
addTest testTrivial

testSwitch() {
  cat >"$tmpDir/2" <<EOF
#!/bin/bash
read line;
echo b
sleep 30
EOF
  chmod +x "$tmpDir/2"
  for ((i=16; i > 0; i--)); do echo a; sleep 1; done | reloadable "$tmpDir/2" > "$tmpDir/2.out" &
  local process="$!"
  sleep 1
  cat >"$tmpDir/2" <<EOF
#!/bin/bash
read line;
echo c
sed 'd'
EOF

  for ((i=15; i > 0; i--)); do
    if cmp -s <( echo -e "b\nc") "$tmpDir/2.out"; then
      killtree "$process"
      return 0
    else
      sleep 1
    fi
  done
  killtree "$process"
  assertFail
}
addTest testSwitch
