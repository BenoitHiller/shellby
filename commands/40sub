#!/bin/bash

source "$botDir/lib/utility.sh"

declare subPid

substitute() {
  local -ri maxLength="$((510 - $(getServerNameLength "$bufferDir") - 50))"
  grep --line-buffered -iE '^\S+\s+privmsg\s+#\S+\s+::.*$' |\
    while read -r line; do
      expression="$(cut -d : -f 3- <<< "$line" | "$botDir/lib/regex.awk")"
      if [ -n "$expression" ]; then
        declare -a data=( $(getIRCInfo "$line") ) 

        "$botDir/lib/sub" "${data[0]}" "$botDir/logs/${data[1]}" "$expression" \
          | sed -E 's/^/=> /' \
          | cut -c-"$maxLength" \
          | tr -d "\a\r\v\n" \
          | "$botDir/lib/privmsg" "${data[1]}" "$(getServerNameLength "$bufferDir")"
   
      fi
    done
}


function reload {
  killtree $subPid
  substitute <&0 &
  subPid=$!
}

trap reload SIGHUP

substitute <&0 &
subPid=$!

while true; do
  wait $subPid
  sleep 1
done
