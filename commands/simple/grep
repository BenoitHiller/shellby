#!/bin/bash

source "$botDir/lib/utility.sh"

# WARNING: disabling globbing. This is probably a good idea almost everywhere.
set -f 

###################
# Input Arguments #
###################

declare -r channel="$2"
declare -r message="${6#*grep }"
declare -r fullMessage="$6"

####################
# Helper Functions #
####################

# Filter log files for those between the specified dates
#
# Consumes a list of null separated files from stdin.
# Outputs the filtered list to stdout.
# 1.firstYear
# 2.firstMonth
# 3.firstDay
# 4.lastYear
# 5.lastMonth
# 6.lastDay
filterDateRange() {
  local -r firstYear="$1"
  local -r firstMonth="$2"
  local -r firstDay="$3"
  local -r lastYear="$4"
  local -r lastMonth="$5"
  local -r lastDay="$6"


  gawk -F "/" '
    BEGIN {
      RS = "\0"
      ORS = "\0"
    }

    {
      min = int(sprintf("%d%02d%02d", firstYear, firstMonth, firstDay))
      max = int(sprintf("%d%02d%02d", lastYear, lastMonth, lastDay))
      year = int($(NF - 2))
      month = int(gensub(/^0*/, "", 1, $(NF - 1)))
      day = int(gensub(/_message|^0*/, "", "g", $NF)) 
      summed = int(sprintf("%d%02d%02d", year, month, day))
      if (summed >= min && summed <= max)
      {
        print $0
      }
    }
  ' firstYear="$firstYear" firstMonth="$firstMonth" firstDay="$firstDay" \
    lastYear="$lastYear" lastMonth="$lastMonth" lastDay="$lastDay"
}

# Formats lines in standard IRC log style
#
# Consumes lines of shellby log format from stdin.
# Outputs formatted lines to stdout.
formatLogLines() {
  gawk -F "\r" '
    /^[0-9]+/{
      if ($5 ~ "message") {
        print "[" strftime("%Y-%m-%d %H:%M:%S",$1) "]", $2 ":", $6
      }
      else if ( $5 ~ "action") {
        print "[" strftime("%Y-%m-%d %H:%M:%S",$1) "]", "*", $2, $6
      }
      else {
        print $0
      }
    }
    /^[^0-9]/{print $0}
  '
}

declare -a assignableParameters=( m e f A B C t T )
declare -a passThroughFlags=( c i E P F )

declare targetChannel

declare -a splitArgs=()
declare -i i=0

resplitAndParse "$message"

if (( "${#vargs[@]}" > 0 )); then

  ###########################
  # Process Time parameters #
  ###########################

  declare -i firstYear=0
  declare -i firstMonth=0
  declare -i firstDay=0
  declare -i lastYear=9999
  declare -i lastMonth=99
  declare -i lastDay=99

  declare -r timeRegex="([0-9]{1,4}|\*)-([0-9]{1,2}|\*)-([0-9]{1,2}|\*)"
  

  if [[ "${argMap[t]+_}" && "${argMap[t]}" =~ $timeRegex ]]; then
    declare firstParts=( $(IFS="-"; echo ${argMap[t]}) )
    if [[ "${firstParts[0]}" != "*" ]]; then
      if [[ "${firstParts[0]}" =~ ^[0-9]{2}$ ]]; then
        firstYear="20${firstParts[0]}"
      else
        firstYear="${firstParts[0]##0}"
      fi
    fi
    if [[ "${firstParts[1]}" != "*" ]]; then
        firstMonth="${firstParts[1]##0}"
    fi
    if [[ "${firstParts[2]}" != "*" ]]; then
        firstDay="${firstParts[2]##0}"
    fi
  fi

  if [[ "${argMap[T]+_}" && "${argMap[T]}" =~ $timeRegex ]]; then
    declare lastParts=( $(IFS="-"; echo ${argMap[T]}) )
    if [[ "${lastParts[0]}" != "*" ]]; then
      if [[ "${lastParts[0]}" =~ ^[0-9]{2}$ ]]; then
        lastYear="20${lastParts[0]}"
      else
        lastYear="${lastParts[0]##0}"
      fi
    fi
    if [[ "${lastParts[1]}" != "*" ]]; then
        lastMonth="${lastParts[1]##0}"
    fi
    if [[ "${lastParts[2]}" != "*" ]]; then
        lastDay="${lastParts[2]##0}"
    fi
  fi

  ############################
  # Process other parameters #
  ############################

  declare gargs="$( printf "%s " "${vargs[@]}" | sed 's/ $//')"

  declare -a gflags=( )

  declare re='^[0-9]+$'

  for f in "${passThroughFlags[@]}"; do
    if [[ "${argMap[$f]+_}" ]]; then
      gflags+=( -$f )
    fi
  done

  if [[ "${argMap[C]+_}" && "${argMap[C]}" =~ $re ]]; then
    gflags+=( -C "${argMap[C]}" )
  else 
    if [[ "${argMap[B]+_}" && "${argMap[B]}" =~ $re ]]; then
      gflags+=( -A "${argMap[B]}" )
    fi
    if [[ "${argMap[A]+_}" && "${argMap[A]}" =~ $re ]]; then
      gflags+=( -B "${argMap[A]}" )
    fi
  fi

  if [[ "${argMap[m]+_}" && "${argMap[m]}" =~ $re ]]; then
    gflags+=( -m "${argMap[m]}" )
  fi

  declare -r channelRegex="^#[^/]+$"

  if [[ "${argMap[f]+_}" && "${argMap[f]}" =~ $channelRegex ]]; then
    targetChannel="${argMap[f]}"
  else
    targetChannel="$channel"
  fi

  declare -ir extendedRegex="${argMap[E]+1}"
  declare -ir perlRegex="${argMap[P]+1}"
  declare -ir fixedMatch="${argMap[F]+1}"

  if (( extendedRegex + perlRegex + fixedMatch > 1 )); then
    echo "conflicting options selected" | privmsg "$channel"
    exit 0
  fi

  if [[ ! "$targetChannel" =~ $channelRegex ]]; then
    exit 0
  fi

  ###################
  # Search pipeline #
  ###################

  find "$botDir/logs/$targetChannel" -type f -name '*_message' -print0 \
    | filterDateRange "$firstYear" "$firstMonth" "$firstDay" "$lastYear" "$lastMonth" "$lastDay" \
    | sort -rz \
    | xargs -0 tac \
    | grep -vF "$fullMessage" \
    | grep "${gflags[@]}" -- "$gargs" \
    | formatLogLines \
    | head -n 500 \
    | tac \
    | privorpaste "$channel" "$(getServerNameLength "$bufferDir")"
fi
